<?php
header('content-type:application/json;charset=utf8');
require_once(dirname(__FILE__).'/'.'../sql_db.php');
require_once(dirname(__FILE__).'/'.'../class/UsualToolCMS_INC.php');
require_once(dirname(__FILE__).'/'.'../class/UsualToolCMS_DB.php');
require_once(dirname(__FILE__).'/'.'../class/UsualToolCMS_WeChat.php');
require_once(dirname(__FILE__).'/'.'../class/UsualToolCMS_AliOpen.php');
$setup=UsualToolCMSDB::queryData("cms_setup","authcode,weburl,indexlanguage","","","1","0")["querydata"][0];
    $authcode=$setup["authcode"];
    $weburl=substr($setup["weburl"],0,-1);
$authrow=UsualToolCMSDB::queryData("cms_routine","","","","1","0")["querydata"][0];
    $wxline=$authrow["wxappline"];
    $wxid=$authrow["wxrteid"];
    $wxsecret=$authrow["wxrtesecret"];
    $alid=$authrow["alrteid"];
    $alappkey=$authrow["alapppubkey"];
    $alpaykey=$authrow["alpaypubkey"];
$type=UsualToolCMS::sqlcheck($_GET["type"]);
$auth=UsualToolCMS::sqlcheck($_GET["auth"]);
$code=UsualToolCMS::sqlcheck($_GET["code"]);
if($authcode==$auth):
	if($type=="wechat"):
	    $result=file_get_contents("https://api.weixin.qq.com/sns/jscode2session?appid=".$wxid."&secret=".$wxsecret."&js_code=".$code."&grant_type=authorization_code");
	elseif($type=="wechat-crypt"):
        $encrypteddata=$_POST["encrypteddata"];
        $iv=$_POST["iv"];
        $openid=UsualToolCMS::sqlcheck($_POST["openid"]);
        $thirdkey=$_POST["thirdkey"];
        $wxin=new UsualToolWeChat($wxline,$wxid,$wxsecret);
        $errcode=$wxin->decryptData($thirdkey,$encrypteddata,$iv,$data);
        if($errcode==0):
            $result=$data;
        else:
            $result=$errcode;
        endif;
	elseif($type=="alipay"):
        $ali=new UsualToolAliOpen($alid,$alappkey,$alpaykey);
        $result=$ali->apiRequest("alipay.system.oauth.token",array("grant_type"=>"authorization_code","code"=>$code));
	else:
		$appid="";
		$appkey="";
		$result="0";
	endif;
	echo$result;
else:
    echo "0";
endif;
?>